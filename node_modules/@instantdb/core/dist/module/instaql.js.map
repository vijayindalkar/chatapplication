{"version":3,"file":"instaql.js","sourceRoot":"","sources":["../../src/instaql.js"],"names":[],"mappings":"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","sourcesContent":["import { query as datalogQuery } from \"./datalog\";\nimport { uuidCompare } from \"./utils/uuid\";\nimport * as s from \"./store\";\n\n// Pattern variables\n// -----------------\n\nlet _seed = 0;\n\nfunction wildcard(friendlyName) {\n  return makeVarImpl(`_${friendlyName}`, _seed++);\n}\n\nfunction makeVarImpl(x, level) {\n  return `?${x}-${level}`;\n}\n\n// Where\n// -----------------\n\nclass AttrNotFoundError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = \"AttrNotFoundError\";\n  }\n}\n\nfunction idAttr(store, ns) {\n  const attr = s.getPrimaryKeyAttr(store, ns);\n\n  if (!attr) {\n    throw new AttrNotFoundError(`Could not find id attr for ${ns}`);\n  }\n  return attr;\n}\n\nfunction defaultWhere(makeVar, store, etype, level) {\n  return [eidWhere(makeVar, store, etype, level)];\n}\n\nfunction eidWhere(makeVar, store, etype, level) {\n  return [\n    makeVar(etype, level),\n    idAttr(store, etype).id,\n    makeVar(etype, level),\n    makeVar(\"time\", level),\n  ];\n}\n\nfunction replaceInAttrPat(attrPat, needle, v) {\n  return attrPat.map((x) => (x === needle ? v : x));\n}\n\nfunction refAttrPat(makeVar, store, etype, level, label) {\n  const fwdAttr = s.getAttrByFwdIdentName(store, etype, label);\n  const revAttr = s.getAttrByReverseIdentName(store, etype, label);\n  const attr = fwdAttr || revAttr;\n\n  if (!attr) {\n    throw new AttrNotFoundError(`Could not find attr for ${[etype, label]}`);\n  }\n\n  if (attr[\"value-type\"] !== \"ref\") {\n    throw new Error(`Attr ${attr.id} is not a ref`);\n  }\n\n  const [_f, fwdEtype] = attr[\"forward-identity\"];\n  const [_r, revEtype] = attr[\"reverse-identity\"];\n  const nextLevel = level + 1;\n  const attrPat = fwdAttr\n    ? [\n        makeVar(fwdEtype, level),\n        attr.id,\n        makeVar(revEtype, nextLevel),\n        wildcard(\"time\"),\n      ]\n    : [\n        makeVar(fwdEtype, nextLevel),\n        attr.id,\n        makeVar(revEtype, level),\n        wildcard(\"time\"),\n      ];\n\n  const nextEtype = fwdAttr ? revEtype : fwdEtype;\n\n  const isForward = Boolean(fwdAttr);\n\n  return [nextEtype, nextLevel, attrPat, attr, isForward];\n}\n\nfunction makeLikeMatcher(caseSensitive, pattern) {\n  if (typeof pattern !== \"string\") {\n    return function likeMatcher(_value) {\n      return false;\n    };\n  }\n  const regexPattern = pattern.replace(/%/g, \".*\").replace(/_/g, \".\");\n  const regex = new RegExp(\n    `^${regexPattern}$`,\n    caseSensitive ? undefined : \"i\",\n  );\n  return function likeMatcher(value) {\n    if (typeof value !== \"string\") {\n      return false;\n    }\n    return regex.test(value);\n  };\n}\n\nfunction parseValue(attr, v) {\n  if (\n    typeof v !== \"object\" ||\n    v.hasOwnProperty(\"$in\") ||\n    v.hasOwnProperty(\"in\")\n  ) {\n    return v;\n  }\n\n  const isDate = attr[\"checked-data-type\"] === \"date\";\n\n  if (v.hasOwnProperty(\"$gt\")) {\n    return {\n      $comparator: true,\n      $op: isDate\n        ? function gtDate(triple) {\n            return new Date(triple[2]) > new Date(v.$gt);\n          }\n        : function gt(triple) {\n            return triple[2] > v.$gt;\n          },\n    };\n  }\n  if (v.hasOwnProperty(\"$gte\")) {\n    return {\n      $comparator: true,\n      $op: isDate\n        ? function gteDate(triple) {\n            return new Date(triple[2]) >= new Date(v.$gte);\n          }\n        : function gte(triple) {\n            return triple[2] >= v.$gte;\n          },\n    };\n  }\n\n  if (v.hasOwnProperty(\"$lt\")) {\n    return {\n      $comparator: true,\n      $op: isDate\n        ? function ltDate(triple) {\n            return new Date(triple[2]) < new Date(v.$lt);\n          }\n        : function lt(triple) {\n            return triple[2] < v.$lt;\n          },\n    };\n  }\n  if (v.hasOwnProperty(\"$lte\")) {\n    return {\n      $comparator: true,\n      $op: isDate\n        ? function lteDate(triple) {\n            return new Date(triple[2]) <= new Date(v.$lte);\n          }\n        : function lte(triple) {\n            return triple[2] <= v.$lte;\n          },\n    };\n  }\n\n  if (v.hasOwnProperty(\"$like\")) {\n    const matcher = makeLikeMatcher(true, v.$like);\n    return {\n      $comparator: true,\n      $op: function like(triple) {\n        return matcher(triple[2]);\n      },\n    };\n  }\n\n  if (v.hasOwnProperty(\"$ilike\")) {\n    const matcher = makeLikeMatcher(false, v.$ilike);\n    return {\n      $comparator: true,\n      $op: function ilike(triple) {\n        return matcher(triple[2]);\n      },\n    };\n  }\n\n  return v;\n}\n\nfunction valueAttrPat(makeVar, store, valueEtype, valueLevel, valueLabel, v) {\n  const fwdAttr = s.getAttrByFwdIdentName(store, valueEtype, valueLabel);\n  const revAttr = s.getAttrByReverseIdentName(store, valueEtype, valueLabel);\n  const attr = fwdAttr || revAttr;\n\n  if (!attr) {\n    throw new AttrNotFoundError(\n      `No attr for etype = ${valueEtype} label = ${valueLabel}`,\n    );\n  }\n\n  if (v?.hasOwnProperty(\"$isNull\")) {\n    const idAttr = s.getAttrByFwdIdentName(store, valueEtype, \"id\");\n    if (!idAttr) {\n      throw new AttrNotFoundError(\n        `No attr for etype = ${valueEtype} label = id`,\n      );\n    }\n\n    return [\n      makeVar(valueEtype, valueLevel),\n      idAttr.id,\n      { $isNull: { attrId: attr.id, isNull: v.$isNull, reverse: !fwdAttr } },\n      wildcard(\"time\"),\n    ];\n  }\n\n  if (fwdAttr) {\n    return [\n      makeVar(valueEtype, valueLevel),\n      attr.id,\n      parseValue(attr, v),\n      wildcard(\"time\"),\n    ];\n  }\n  return [v, attr.id, makeVar(valueEtype, valueLevel), wildcard(\"time\")];\n}\n\nfunction refAttrPats(makeVar, store, etype, level, refsPath) {\n  const [lastEtype, lastLevel, attrPats] = refsPath.reduce(\n    (acc, label) => {\n      const [etype, level, attrPats] = acc;\n      const [nextEtype, nextLevel, attrPat] = refAttrPat(\n        makeVar,\n        store,\n        etype,\n        level,\n        label,\n      );\n      return [nextEtype, nextLevel, [...attrPats, attrPat]];\n    },\n    [etype, level, []],\n  );\n\n  return [lastEtype, lastLevel, attrPats];\n}\n\nfunction whereCondAttrPats(makeVar, store, etype, level, path, v) {\n  const refsPath = path.slice(0, path.length - 1);\n  const valueLabel = path[path.length - 1];\n  const [lastEtype, lastLevel, refPats] = refAttrPats(\n    makeVar,\n    store,\n    etype,\n    level,\n    refsPath,\n  );\n  const valuePat = valueAttrPat(\n    makeVar,\n    store,\n    lastEtype,\n    lastLevel,\n    valueLabel,\n    v,\n  );\n\n  return refPats.concat([valuePat]);\n}\n\nfunction withJoin(where, join) {\n  return join ? [join].concat(where) : where;\n}\n\nfunction isOrClauses([k, v]) {\n  return k === \"or\" && Array.isArray(v);\n}\n\nfunction isAndClauses([k, v]) {\n  return k === \"and\" && Array.isArray(v);\n}\n\n// Creates a makeVar that will namespace symbols for or clauses\n// to prevent conflicts, except for the base etype\nfunction genMakeVar(baseMakeVar, etype, orIdx) {\n  return (x, lvl) => {\n    if (x == etype) {\n      return baseMakeVar(x, lvl);\n    }\n    return `${baseMakeVar(x, lvl)}-${orIdx}`;\n  };\n}\n\nfunction parseWhereClauses(\n  makeVar,\n  clauseType /* 'or' | 'and' */,\n  store,\n  etype,\n  level,\n  whereValue,\n) {\n  const patterns = whereValue.map((w, i) => {\n    const makeNamespacedVar = genMakeVar(makeVar, etype, i);\n    return parseWhere(makeNamespacedVar, store, etype, level, w);\n  });\n  const joinSym = makeVar(etype, level);\n  return { [clauseType]: { patterns, joinSym } };\n}\n\n// Given a path, returns a list of paths leading up to this path:\n// growPath([1, 2, 3]) -> [[1], [1, 2], [1, 2, 3]]\nfunction growPath(path) {\n  const ret = [];\n  for (let i = 1; i <= path.length; i++) {\n    ret.push(path.slice(0, i));\n  }\n  return ret;\n}\n\n// Returns array of pattern arrays that should be grouped in OR\n// to capture any intermediate nulls\nfunction whereCondAttrPatsForNullIsTrue(makeVar, store, etype, level, path) {\n  return growPath(path).map((path) =>\n    whereCondAttrPats(makeVar, store, etype, level, path, { $isNull: true }),\n  );\n}\n\nfunction parseWhere(makeVar, store, etype, level, where) {\n  return Object.entries(where).flatMap(([k, v]) => {\n    if (isOrClauses([k, v])) {\n      return parseWhereClauses(makeVar, \"or\", store, etype, level, v);\n    }\n    if (isAndClauses([k, v])) {\n      return parseWhereClauses(makeVar, \"and\", store, etype, level, v);\n    }\n\n    const path = k.split(\".\");\n\n    if (v?.hasOwnProperty(\"$not\")) {\n      // `$not` won't pick up entities that are missing the attr, so we\n      // add in a `$isNull` to catch those too.\n      const notPats = whereCondAttrPats(makeVar, store, etype, level, path, v);\n      const nilPats = whereCondAttrPatsForNullIsTrue(\n        makeVar,\n        store,\n        etype,\n        level,\n        path,\n      );\n      return [\n        {\n          or: {\n            patterns: [notPats, ...nilPats],\n            joinSym: makeVar(etype, level),\n          },\n        },\n      ];\n    }\n\n    if (v?.hasOwnProperty(\"$isNull\") && v.$isNull === true && path.length > 1) {\n      // Make sure we're capturing all of the intermediate paths that might be null\n      // by checking for null at each step along the path\n      return [\n        {\n          or: {\n            patterns: whereCondAttrPatsForNullIsTrue(\n              makeVar,\n              store,\n              etype,\n              level,\n              path,\n            ),\n            joinSym: makeVar(etype, level),\n          },\n        },\n      ];\n    }\n\n    return whereCondAttrPats(makeVar, store, etype, level, path, v);\n  });\n}\n\nfunction makeWhere(store, etype, level, where) {\n  const makeVar = makeVarImpl;\n  if (!where) {\n    return defaultWhere(makeVar, store, etype, level);\n  }\n  const parsedWhere = parseWhere(makeVar, store, etype, level, where);\n  return parsedWhere.concat(defaultWhere(makeVar, store, etype, level));\n}\n\n// Find\n// -----------------\n\nfunction makeFind(makeVar, etype, level) {\n  return [makeVar(etype, level), makeVar(\"time\", level)];\n}\n\n// extendObjects\n// -----------------\n\nfunction makeJoin(makeVar, store, etype, level, label, eid) {\n  const [nextEtype, nextLevel, pat, attr, isForward] = refAttrPat(\n    makeVar,\n    store,\n    etype,\n    level,\n    label,\n  );\n  const actualized = replaceInAttrPat(pat, makeVar(etype, level), eid);\n  return [nextEtype, nextLevel, actualized, attr, isForward];\n}\n\nfunction extendObjects(makeVar, store, { etype, level, form }, objects) {\n  const childQueries = Object.keys(form).filter((c) => c !== \"$\");\n  if (!childQueries.length) {\n    return Object.values(objects);\n  }\n  return Object.entries(objects).map(function extendChildren([eid, parent]) {\n    const childResults = childQueries.map(function getChildResult(label) {\n      const isSingular = Boolean(\n        store.cardinalityInference &&\n          store.linkIndex?.[etype]?.[label]?.isSingular,\n      );\n\n      try {\n        const [nextEtype, nextLevel, join] = makeJoin(\n          makeVar,\n          store,\n          etype,\n          level,\n          label,\n          eid,\n        );\n\n        const childrenArray = queryOne(store, {\n          etype: nextEtype,\n          level: nextLevel,\n          form: form[label],\n          join,\n        });\n\n        const childOrChildren = isSingular ? childrenArray[0] : childrenArray;\n\n        return { [label]: childOrChildren };\n      } catch (e) {\n        if (e instanceof AttrNotFoundError) {\n          return { [label]: isSingular ? undefined : [] };\n        }\n        throw e;\n      }\n    });\n\n    return childResults.reduce(function reduceChildren(parent, child) {\n      return { ...parent, ...child };\n    }, parent);\n  });\n}\n\n// resolveObjects\n// -----------------\n\nfunction shouldIgnoreAttr(attrs, id) {\n  const attr = attrs[id];\n  return attr[\"value-type\"] === \"ref\" && attr[\"forward-identity\"][2] !== \"id\";\n}\n\nfunction compareOrder([id_a, v_a], [id_b, v_b]) {\n  if (v_a === v_b || (v_a == null && v_b == null)) {\n    return uuidCompare(id_a, id_b);\n  }\n\n  if (v_b == null) {\n    return 1;\n  }\n  if (v_a == null) {\n    return -1;\n  }\n  if (v_a > v_b) {\n    return 1;\n  }\n  return -1;\n}\n\nfunction comparableDate(x) {\n  if (x == null) {\n    return x;\n  }\n  return new Date(x).getTime();\n}\n\nfunction isBefore(startCursor, orderAttr, direction, idVec) {\n  const [c_e, _c_a, c_v, c_t] = startCursor;\n  const compareVal = direction === \"desc\" ? 1 : -1;\n  if (orderAttr[\"forward-identity\"]?.[2] === \"id\") {\n    return compareOrder(idVec, [c_e, c_t]) === compareVal;\n  }\n  const [e, v] = idVec;\n  const v_new =\n    orderAttr[\"checked-data-type\"] === \"date\" ? comparableDate(v) : v;\n  const c_v_new =\n    orderAttr[\"checked-data-type\"] === \"date\" ? comparableDate(c_v) : c_v;\n  return compareOrder([e, v_new], [c_e, c_v_new]) === compareVal;\n}\n\nfunction orderAttrFromCursor(store, cursor) {\n  const cursorAttrId = cursor[1];\n  return store.attrs[cursorAttrId];\n}\n\nfunction orderAttrFromOrder(store, etype, order) {\n  const label = Object.keys(order)[0];\n  return s.getAttrByFwdIdentName(store, etype, label);\n}\n\nfunction getOrderAttr(store, etype, cursor, order) {\n  if (cursor) {\n    return orderAttrFromCursor(store, cursor);\n  }\n  if (order) {\n    return orderAttrFromOrder(store, etype, order);\n  }\n}\n\nfunction runDataloadAndReturnObjects(\n  store,\n  etype,\n  direction,\n  pageInfo,\n  order,\n  dq,\n) {\n  let idVecs = datalogQuery(store, dq);\n\n  const startCursor = pageInfo?.[\"start-cursor\"];\n  const orderAttr = getOrderAttr(store, etype, startCursor, order);\n\n  if (orderAttr && orderAttr?.[\"forward-identity\"]?.[2] !== \"id\") {\n    const isDate = orderAttr[\"checked-data-type\"] === \"date\";\n    const a = orderAttr.id;\n    idVecs = idVecs.map(([id]) => {\n      // order attr is required to be cardinality one, so there will\n      // be at most one value here\n      let v = store.eav.get(id)?.get(a)?.values()?.next()?.value?.[2];\n      if (isDate) {\n        v = comparableDate(v);\n      }\n      return [id, v];\n    });\n  }\n\n  idVecs.sort(\n    direction === \"asc\"\n      ? function compareIdVecs(a, b) {\n          return compareOrder(a, b);\n        }\n      : function compareIdVecs(a, b) {\n          return compareOrder(b, a);\n        },\n  );\n\n  let objects = {};\n\n  for (const idVec of idVecs) {\n    const [id] = idVec;\n    if (objects[id]) {\n      continue;\n    }\n    if (\n      startCursor &&\n      orderAttr &&\n      isBefore(startCursor, orderAttr, direction, idVec)\n    ) {\n      continue;\n    }\n\n    const obj = s.getAsObject(store, etype, id);\n    if (obj) {\n      objects[id] = obj;\n    }\n  }\n  return objects;\n}\n\nfunction determineOrder(form) {\n  const orderOpts = form.$?.order;\n  if (!orderOpts) {\n    return \"asc\";\n  }\n\n  return orderOpts[Object.keys(orderOpts)[0]] || \"asc\";\n}\n\n/**\n * Given a query like:\n *\n * {\n *   users: {\n *     $: { where: { name: \"Joe\" } },\n *   },\n * };\n *\n * `resolveObjects`, turns where clause: `{ name: \"Joe\" }`\n * into a datalog query. We then run the datalog query,\n * and reduce all the triples into objects.\n */\nfunction resolveObjects(store, { etype, level, form, join, pageInfo }) {\n  const limit = form.$?.limit || form.$?.first || form.$?.last;\n  const offset = form.$?.offset;\n  const before = form.$?.before;\n  const after = form.$?.after;\n  const order = form.$?.order;\n\n  // Wait for server to tell us where we start if we don't start from the beginning\n  if ((offset || before || after) && (!pageInfo || !pageInfo[\"start-cursor\"])) {\n    return [];\n  }\n  const where = withJoin(makeWhere(store, etype, level, form.$?.where), join);\n\n  const find = makeFind(makeVarImpl, etype, level);\n\n  const objs = runDataloadAndReturnObjects(\n    store,\n    etype,\n    determineOrder(form),\n    pageInfo,\n    order,\n    { where, find },\n  );\n\n  if (limit != null) {\n    const entries = Object.entries(objs);\n    if (entries.length <= limit) {\n      return objs;\n    }\n    return Object.fromEntries(entries.slice(0, limit));\n  }\n  return objs;\n}\n\n/**\n * It's possible that we query\n * for an attribute that doesn't exist yet.\n *\n * { users: { $: { where: { nonExistentProperty: \"foo\" } } } }\n *\n * This swallows the missing attr error and returns\n * an empty result instead\n */\nfunction guardedResolveObjects(store, opts) {\n  try {\n    return resolveObjects(store, opts);\n  } catch (e) {\n    if (e instanceof AttrNotFoundError) {\n      return {};\n    }\n    throw e;\n  }\n}\n/**\n * Given a query like:\n *\n * {\n *   users: {\n *     $: { where: { name: \"Joe\" } },\n *     posts: {},\n *   },\n * };\n *\n * `guardResolveObjects` will return the relevant `users` objects\n * `extendObjects` will then extend each `user` object with relevant `posts`.\n */\nfunction queryOne(store, opts) {\n  const objects = guardedResolveObjects(store, opts);\n  return extendObjects(makeVarImpl, store, opts, objects);\n}\n\nfunction formatPageInfo(pageInfo) {\n  const res = {};\n  for (const [k, v] of Object.entries(pageInfo)) {\n    res[k] = {\n      startCursor: v[\"start-cursor\"],\n      endCursor: v[\"end-cursor\"],\n      hasNextPage: v[\"has-next-page?\"],\n      hasPreviousPage: v[\"has-previous-page?\"],\n    };\n  }\n  return res;\n}\n\nexport default function query({ store, pageInfo, aggregate }, q) {\n  const data = Object.keys(q).reduce(function reduceResult(res, k) {\n    if (aggregate?.[k]) {\n      // Aggregate doesn't return any join rows and has no children,\n      // so don't bother querying further\n      return res;\n    }\n    res[k] = queryOne(store, {\n      etype: k,\n      form: q[k],\n      level: 0,\n      pageInfo: pageInfo?.[k],\n    });\n    return res;\n  }, {});\n\n  const result = { data };\n  if (pageInfo) {\n    result.pageInfo = formatPageInfo(pageInfo);\n  }\n\n  if (aggregate) {\n    result.aggregate = aggregate;\n  }\n\n  return result;\n}\n"]}