{"version":3,"file":"schema.js","sourceRoot":"","sources":["../../src/schema.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  EntityDef,\n  DataAttrDef,\n  InstantSchemaDef,\n  type EntitiesDef,\n  type AttrsDefs,\n  type EntitiesWithLinks,\n  type LinksDef,\n  type RoomsDef,\n  type UnknownRooms,\n} from \"./schemaTypes\";\n\n// ==========\n// API\n\n/**\n * @deprecated\n * `i.graph` is deprecated. Use `i.schema` instead.\n *\n * @example\n * // Before\n * i.graph(entities, links).withRoomSchema<RoomType>();\n *\n * // After\n * i.schema({ entities, links, rooms })\n *\n * @see\n * https://instantdb.com/docs/schema\n */\nfunction graph<\n  EntitiesWithoutLinks extends EntitiesDef,\n  const Links extends LinksDef<EntitiesWithoutLinks>,\n>(entities: EntitiesWithoutLinks, links: Links) {\n  return new InstantSchemaDef(\n    enrichEntitiesWithLinks<EntitiesWithoutLinks, Links>(entities, links),\n    // (XXX): LinksDef<any> stems from TypeScript’s inability to reconcile the\n    // type EntitiesWithLinks<EntitiesWithoutLinks, Links> with\n    // EntitiesWithoutLinks. TypeScript is strict about ensuring that types are\n    // correctly aligned and does not allow for substituting a type that might\n    // be broader or have additional properties.\n    links as LinksDef<any>,\n    undefined as UnknownRooms,\n  );\n}\n\n/**\n * Creates an entity definition, to be used in conjunction with `i.graph`.\n *\n * @see https://instantdb.com/docs/schema\n * @example\n *   {\n *     posts: i.entity({\n *       title: i.string(),\n *       body: i.string(),\n *     }),\n *     comments: i.entity({\n *       body: i.string(),\n *     })\n *   }\n */\nfunction entity<Attrs extends AttrsDefs>(\n  attrs: Attrs,\n): EntityDef<Attrs, {}, void> {\n  return new EntityDef(attrs, {});\n}\n\nfunction string<StringEnum extends string = string>(): DataAttrDef<\n  StringEnum,\n  true\n> {\n  return new DataAttrDef(\"string\", true);\n}\n\nfunction number(): DataAttrDef<number, true> {\n  return new DataAttrDef(\"number\", true);\n}\n\nfunction boolean(): DataAttrDef<boolean, true> {\n  return new DataAttrDef(\"boolean\", true);\n}\n\nfunction date(): DataAttrDef<string | number, true> {\n  return new DataAttrDef(\"date\", true);\n}\n\nfunction json<T = any>(): DataAttrDef<T, true> {\n  return new DataAttrDef(\"json\", true);\n}\n\nfunction any(): DataAttrDef<any, true> {\n  return new DataAttrDef(\"json\", true);\n}\n\n// ==========\n// internal\n\nfunction enrichEntitiesWithLinks<\n  EntitiesWithoutLinks extends EntitiesDef,\n  Links extends LinksDef<any>,\n  EnrichedEntities = EntitiesWithLinks<EntitiesWithoutLinks, Links>,\n>(entities: EntitiesWithoutLinks, links: Links): EnrichedEntities {\n  const linksIndex: LinksIndex = { fwd: {}, rev: {} };\n\n  for (const linkDef of Object.values(links)) {\n    linksIndex.fwd[linkDef.forward.on as string] ||= {};\n    linksIndex.rev[linkDef.reverse.on as string] ||= {};\n\n    linksIndex.fwd[linkDef.forward.on as string][linkDef.forward.label] = {\n      entityName: linkDef.reverse.on as string,\n      cardinality: linkDef.forward.has,\n    };\n\n    linksIndex.rev[linkDef.reverse.on as string][linkDef.reverse.label] = {\n      entityName: linkDef.forward.on as string,\n      cardinality: linkDef.reverse.has,\n    };\n  }\n\n  const enrichedEntities = Object.fromEntries(\n    Object.entries(entities).map(([name, def]) => [\n      name,\n      new EntityDef(def.attrs, {\n        ...linksIndex.fwd[name],\n        ...linksIndex.rev[name],\n      }),\n    ]),\n  );\n\n  return enrichedEntities as EnrichedEntities;\n}\n\ntype LinksIndex = Record<\n  \"fwd\" | \"rev\",\n  Record<string, Record<string, { entityName: string; cardinality: string }>>\n>;\n\n/**\n * Lets you define a schema for your database.\n *\n * You can define entities, links between entities, and if you use\n * presence, you can define rooms.\n *\n * You can push this schema to your database with the CLI,\n * or use it inside `init`, to get typesafety and autocompletion.\n *\n * @see https://instantdb.com/docs/schema\n * @example\n *   i.schema({\n *     entities: { },\n *     links: { },\n *     rooms: { }\n *   });\n */\nfunction schema<\n  EntitiesWithoutLinks extends EntitiesDef,\n  const Links extends LinksDef<EntitiesWithoutLinks>,\n  Rooms extends RoomsDef,\n>({\n  entities,\n  links,\n  rooms,\n}: {\n  entities: EntitiesWithoutLinks;\n  links?: Links;\n  rooms?: Rooms;\n}) {\n  const linksDef = links ?? {} as Links;\n  const roomsDef = rooms ?? {} as Rooms;\n  return new InstantSchemaDef(\n    enrichEntitiesWithLinks<EntitiesWithoutLinks, Links>(entities, linksDef),\n    // (XXX): LinksDef<any> stems from TypeScript’s inability to reconcile the\n    // type EntitiesWithLinks<EntitiesWithoutLinks, Links> with\n    // EntitiesWithoutLinks. TypeScript is strict about ensuring that types are\n    // correctly aligned and does not allow for substituting a type that might\n    // be broader or have additional properties.\n    linksDef as LinksDef<any>,\n    roomsDef,\n  );\n}\n\nexport const i = {\n  // constructs\n  graph,\n  schema,\n  entity,\n  // value types\n  string,\n  number,\n  boolean,\n  date,\n  json,\n  any,\n};\n"]}